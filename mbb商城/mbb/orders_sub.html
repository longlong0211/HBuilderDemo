<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/orders.css" />
	</head>

	<body>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul id="theList" class='list-orders'>
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/common.js "></script>
		<script src="js/order.js"></script>
		<script src="js/payment.js"></script>
		<script type="text/javascript" charset="utf-8">var user=null,page=1;var pays={};mui.init({pullRefresh:{container:"#pullrefresh",down:{callback:pulldownRefresh},up:{contentrefresh:"正在加载...",callback:pullupRefresh}}});document.addEventListener("refresh",function(a){loadOrders("",true)});mui("#theList").on("tap","a",function(d){var f=this.getAttribute("data-id"),b=this.getAttribute("data-action");switch(b){case"show":mui.openWindow({id:"order.html",url:"order.html",waiting:{autoShow:true},extras:{eid:f}});break;case"pay":var a=this.getAttribute("data-pay_code");if(a!="wxpay"){a="alipay"}orderPay(f,"order",function(e){orderPay({order:e,code:a},"app")});break;case"cancel":orderCancel(f,"cancel");break;case"affirm":orderAffirm(f);break;case"kd":var c=this.getAttribute("invoice_no");orderKD(A.invoice_no);break}});function pulldownRefresh(){setTimeout(function(){page=1;loadOrders("down",true)},1500)}var count=0;function pullupRefresh(){setTimeout(function(){loadOrders("up")},1500)}if(mui.os.plus){mui.plusReady(function(){init();setTimeout(function(){mui("#pullrefresh").pullRefresh().pullupLoading()},1000)})}else{mui.ready(function(){init();mui("#pullrefresh").pullRefresh().pullupLoading()})}function init(){user=getCachedUser(true);plus.payment.getChannels(function(e){for(var d in e){var f=e[d];pays[f.id]=f}},function(b){console.log("获取支付通道失败："+b.message)})}function loadOrders(b){var d=(typeof arguments[1]=="boolean"&&arguments[1]);var c=plus.webview.currentWebview(),a=c.opener();mui.sendRequest(mui.constMap.ROOT_PATH+"/order/list",{session:user.session,pagination:{page:page++,count:5},type:a.type,config:{silence:true}},function(e){if(!e.status.succeed){mui.toast(e.status.error_desc);return}if(b=="up"){mui("#pullrefresh").pullRefresh().endPullupToRefresh(!e.paginated.more)}fillOrders(e.data,d);if(b=="down"){mui("#pullrefresh").pullRefresh().endPulldownToRefresh()}})}function fillOrders(a,b){var d=document.querySelector(".list-orders"),c=document.createDocumentFragment();if(b){d.innerHTML=""}mui.each(a,function(e,f){fillOrdersUL(c,f)});d.appendChild(c)}function fillOrdersUL(a,t){var u=document,q=u.createElement("li"),s=u.createElement("div"),p=u.createElement("span"),e=u.createElement("span"),r=u.createElement("ul"),j=u.createElement("div"),f=u.createElement("span"),l=u.createElement("span"),k=u.createElement("span"),i=u.createElement("span"),g=u.createElement("div");q.className="list-myorder";s.setAttribute("class","ordernumber");p.setAttribute("class","order-num");p.innerHTML=t.order_sn;e.setAttribute("class","order-date");e.innerHTML=t.order_time;r.setAttribute("class","ul-product");var b=0;mui.each(t.goods_list,function(v,n){r.appendChild(fillSegGoods(t.order_id,n));b+=parseInt(n.goods_number)});j.setAttribute("class","totle");f.setAttribute("class","status");f.innerHTML=t.order_status;l.setAttribute("class","price");l.innerHTML=t.total_fee;k.setAttribute("class","pric-lable");k.innerHTML="总价";i.setAttribute("class","prc-num");i.innerHTML="共"+b+"件";g.setAttribute("class","div-button");if(t.pay_status=="未付款"&&t.order_status_s!="已取消"){var d=u.createElement("a");d.setAttribute("class","button [radius round] gray");d.innerHTML="立即支付";d.setAttribute("data-id",t.order_id);d.setAttribute("data-pay_code",t.pay_code);d.setAttribute("data-action","pay");g.appendChild(d)}if(t.order_status_s=="未确认"){var m=u.createElement("a");m.setAttribute("class","button [radius round] gray");m.innerHTML="取消订单";m.setAttribute("data-id",t.order_id);m.setAttribute("data-action","cancel");g.appendChild(m)}else{if(t.shipping_status=="已发货"){var c=u.createElement("a"),h=u.createElement("a");c.setAttribute("class","button [radius round] gray");c.innerHTML="确认收货";c.setAttribute("data-id",t.order_id);c.setAttribute("data-action","affirm");g.appendChild(c);h.setAttribute("class","button [radius round] gray");h.innerHTML="查看物流";h.setAttribute("data-id",t.order_id);h.setAttribute("data-invoice_no",t.invoice_no);h.setAttribute("data-action","kd");g.appendChild(h)}else{var o=u.createElement("a");o.setAttribute("data-id",t.order_id);o.setAttribute("class","button [radius round] gray aEvent");o.innerHTML="查看详情";o.setAttribute("data-id",t.order_id);o.setAttribute("data-action","show");g.appendChild(o)}}s.appendChild(p);s.appendChild(e);j.appendChild(f);j.appendChild(l);j.appendChild(k);j.appendChild(i);q.appendChild(s);q.appendChild(r);q.appendChild(j);q.appendChild(g);a.appendChild(q)}function fillSegGoods(j,b){var l=document,r=l.createElement("li"),i=l.createElement("a"),n=l.createElement("span"),c=l.createElement("img"),d=l.createElement("div"),e=l.createElement("span"),g=l.createElement("div"),h=l.createElement("span"),p=l.createElement("div"),o=l.createElement("span"),f=l.createElement("div");i.setAttribute("class","aEvent");i.setAttribute("data-id",j);i.setAttribute("data-action","show");n.setAttribute("class","pic");c.setAttribute("src",b.img.thumb);d.setAttribute("class","text");var q="";mui.each(b.goods_attr,function(a,s){q+=s.value+" "});e.setAttribute("class","pro-name");e.innerHTML=b.name;g.setAttribute("class","pro-pric");h.innerHTML="价格：";var m=l.createTextNode(b.formated_shop_price);p.setAttribute("class","pro-pec");o.innerHTML="规格：";var k=l.createTextNode(q);n.appendChild(c);g.appendChild(h);g.appendChild(m);p.appendChild(o);p.appendChild(k);d.appendChild(e);d.appendChild(g);d.appendChild(p);i.appendChild(n);i.appendChild(d);r.appendChild(i);f.setAttribute("class","div-return");r.appendChild(f);return r};</script>
	</body>

</html>